<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">{- |
   Module     : Main
   Copyright  : Copyright (C) 2017 Johannes Hartmann, Liam Kelly, Manuel Campos Villarreal
   License    : MIT

   Maintainer : Johannes Hartmann &lt;ec17512@qmul.ac.uk&gt;
   Stability  : provisional
   Portability: portable

   This purpose of the application is to download all the recent movies from the TheMovieDB API and
   stores them into a SQLite database.
   Main Functionality is as Follows: The user types in an actor in the Console; The application
   will look this actor up and print out all movies he's playing in.
   Then, for a given location it suggests cinemas in the areas that play this movie.

   Written by Johannes Hartmann, Liam Kelly, Manuel Campos Villarreal
-}</span><span>
</span><a name="line-18"></a><span>
</span><a name="line-19"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Main</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-20"></a><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><a href="HTTPRequestModule.html"><span class="hs-identifier">HTTPRequestModule</span></a><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><a href="HTTPRequestModule2.html"><span class="hs-identifier">HTTPRequestModule2</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><a href="DataBaseModule.html"><span class="hs-identifier">DataBaseModule</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><a href="IOActionModule.html"><span class="hs-identifier">IOActionModule</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><a href="DataStructures.html"><span class="hs-identifier">DataStructures</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><a href="JSONParserModule.html"><span class="hs-identifier">JSONParserModule</span></a><span>
</span><a name="line-27"></a><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Network</span><span class="hs-operator">.</span><span class="hs-identifier">HTTP</span><span class="hs-operator">.</span><span class="hs-identifier">Conduit</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">N</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">DateTime</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-comment">{- | The real application function. This function is responsible for filling up the database and interacting with the user.
     This function throws lots of exceptions witch will be handled in
     the main function -}</span><span>
</span><a name="line-37"></a><span class="hs-identifier">run</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-38"></a><a name="run"><a href="Main.html#run"><span class="hs-identifier">run</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-39"></a><span>  </span><a name="local-1627468879"><a href="#local-1627468879"><span class="hs-identifier">conn</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DataBaseModule.html#dbConnect"><span class="hs-identifier hs-var">dbConnect</span></a><span>
</span><a name="line-40"></a><span>  </span><a href="DataBaseModule.html#initialiseDB"><span class="hs-identifier hs-var">initialiseDB</span></a><span> </span><a href="#local-1627468879"><span class="hs-identifier hs-var">conn</span></a><span>
</span><a name="line-41"></a><span>  </span><a name="local-1627468880"><a href="#local-1627468880"><span class="hs-identifier">date</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">getCurrentTime</span><span>
</span><a name="line-42"></a><span>
</span><a name="line-43"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-1627468881"><a href="#local-1627468881"><span class="hs-identifier">lastMonthDay</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="HTTPRequestModule.html#getDateString"><span class="hs-identifier hs-var">getDateString</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">addMinutes</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">2</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-number">30</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-number">24</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-number">60</span><span class="hs-special">)</span><span> </span><a href="#local-1627468880"><span class="hs-identifier hs-var">date</span></a><span class="hs-special">)</span><span> </span><span class="hs-comment">-- two months</span><span>
</span><a name="line-44"></a><span>  </span><a href="DataBaseModule.html#cleanupDatabase"><span class="hs-identifier hs-var">cleanupDatabase</span></a><span> </span><a href="#local-1627468879"><span class="hs-identifier hs-var">conn</span></a><span> </span><span class="hs-special">(</span><a href="HTTPRequestModule.html#getDateString"><span class="hs-identifier hs-var">getDateString</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">addMinutes</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">6</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-number">30</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-number">24</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><span class="hs-number">60</span><span class="hs-special">)</span><span> </span><a href="#local-1627468880"><span class="hs-identifier hs-var">date</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- six months</span><span>
</span><a name="line-45"></a><span>  </span><a name="local-1627468882"><a href="#local-1627468882"><span class="hs-identifier">lastMovieDate</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DataBaseModule.html#getDateOfLastMoveInDB"><span class="hs-identifier hs-var">getDateOfLastMoveInDB</span></a><span> </span><a href="#local-1627468879"><span class="hs-identifier hs-var">conn</span></a><span>
</span><a name="line-46"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-1627468883"><a href="#local-1627468883"><span class="hs-identifier">movieHandle</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1627468884"><a href="#local-1627468884"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">N</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">HttpException</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><a href="DataStructures.html#Movie"><span class="hs-identifier hs-type">Movie</span></a><span class="hs-special">]</span><span>
</span><a name="line-47"></a><span>  </span><a name="local-1627468885"><a href="#local-1627468885"><span class="hs-identifier">listOfMovies</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">handle</span><span> </span><a href="#local-1627468883"><span class="hs-identifier hs-var">movieHandle</span></a><span>
</span><a name="line-48"></a><span>                  </span><span class="hs-special">(</span><a href="HTTPRequestModule.html#httpGetListOfMovies"><span class="hs-identifier hs-var">httpGetListOfMovies</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fromMaybe</span><span> </span><a href="#local-1627468881"><span class="hs-identifier hs-var">lastMonthDay</span></a><span> </span><a href="#local-1627468882"><span class="hs-identifier hs-var">lastMovieDate</span></a><span class="hs-special">)</span><span>
</span><a name="line-49"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-1627468886"><a href="#local-1627468886"><span class="hs-identifier">actorHandle</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1627468887"><a href="#local-1627468887"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">N</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">HttpException</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><a href="DataStructures.html#Actor"><span class="hs-identifier hs-type">Actor</span></a><span class="hs-special">]</span><span>
</span><a name="line-50"></a><span>  </span><a name="local-1627468888"><a href="#local-1627468888"><span class="hs-identifier">listOfActors</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">handle</span><span> </span><a href="#local-1627468886"><span class="hs-identifier hs-var">actorHandle</span></a><span> </span><span class="hs-special">(</span><a href="HTTPRequestModule.html#httpGetListOfActores"><span class="hs-identifier hs-var">httpGetListOfActores</span></a><span> </span><a href="#local-1627468885"><span class="hs-identifier hs-var">listOfMovies</span></a><span class="hs-special">)</span><span>
</span><a name="line-51"></a><span>  </span><a href="DataBaseModule.html#insertMovieIntoDB"><span class="hs-identifier hs-var">insertMovieIntoDB</span></a><span> </span><a href="#local-1627468879"><span class="hs-identifier hs-var">conn</span></a><span> </span><a href="#local-1627468885"><span class="hs-identifier hs-var">listOfMovies</span></a><span>
</span><a name="line-52"></a><span>  </span><a href="DataBaseModule.html#insertActorIntoDB"><span class="hs-identifier hs-var">insertActorIntoDB</span></a><span> </span><a href="#local-1627468879"><span class="hs-identifier hs-var">conn</span></a><span> </span><a href="#local-1627468888"><span class="hs-identifier hs-var">listOfActors</span></a><span>
</span><a name="line-53"></a><span>  </span><a name="local-1627468889"><a href="#local-1627468889"><span class="hs-identifier">movies</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DataBaseModule.html#getMoviesFromDatabase"><span class="hs-identifier hs-var">getMoviesFromDatabase</span></a><span> </span><a href="#local-1627468879"><span class="hs-identifier hs-var">conn</span></a><span>
</span><a name="line-54"></a><span>  </span><a name="local-1627468890"><a href="#local-1627468890"><span class="hs-identifier">actoreName</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="IOActionModule.html#askForActor"><span class="hs-identifier hs-var">askForActor</span></a><span>
</span><a name="line-55"></a><span>  </span><a name="local-1627468891"><a href="#local-1627468891"><span class="hs-identifier">movie</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="DataBaseModule.html#searchMoviesInDB"><span class="hs-identifier hs-var">searchMoviesInDB</span></a><span> </span><a href="#local-1627468879"><span class="hs-identifier hs-var">conn</span></a><span> </span><a href="#local-1627468890"><span class="hs-identifier hs-var">actoreName</span></a><span>
</span><a name="line-56"></a><span>  </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627468891"><span class="hs-identifier hs-var">movie</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-57"></a><span>    </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-58"></a><span>      </span><a href="DataBaseModule.html#disconnectDB"><span class="hs-identifier hs-var">disconnectDB</span></a><span> </span><a href="#local-1627468879"><span class="hs-identifier hs-var">conn</span></a><span>
</span><a name="line-59"></a><span>      </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;Could't find a movie for the given actor&quot;</span><span>
</span><a name="line-60"></a><span>    </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-1627468921"><a href="#local-1627468921"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="IOActionModule.html#printMovies"><span class="hs-identifier hs-var">printMovies</span></a><span> </span><a href="#local-1627468921"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-61"></a><span>  </span><a name="local-1627468922"><a href="#local-1627468922"><span class="hs-identifier">movieIndex</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="IOActionModule.html#askToSelectMovie"><span class="hs-identifier hs-var">askToSelectMovie</span></a><span>
</span><a name="line-62"></a><span>  </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-1627468922"><span class="hs-identifier hs-var">movieIndex</span></a><span> </span><span class="hs-operator hs-var">&gt;</span><span> </span><span class="hs-identifier hs-var">length</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromJust</span><span> </span><a href="#local-1627468891"><span class="hs-identifier hs-var">movie</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="DataBaseModule.html#disconnectDB"><span class="hs-identifier hs-var">disconnectDB</span></a><span> </span><a href="#local-1627468879"><span class="hs-identifier hs-var">conn</span></a><span>
</span><a name="line-63"></a><span>    </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;Wrong Input&quot;</span><span>
</span><a name="line-64"></a><span>  </span><a name="local-1627468923"><a href="#local-1627468923"><span class="hs-identifier">location</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="IOActionModule.html#askForLocation"><span class="hs-identifier hs-var">askForLocation</span></a><span>
</span><a name="line-65"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-1627468924"><a href="#local-1627468924"><span class="hs-identifier">cinemaHandle</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1627468925"><a href="#local-1627468925"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DataBaseModule.html#disconnectDB"><span class="hs-identifier hs-var">disconnectDB</span></a><span> </span><a href="#local-1627468879"><span class="hs-identifier hs-var">conn</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;No cinema found for your location&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">N</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">HttpException</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><a href="DataStructures.html#Cinema"><span class="hs-identifier hs-type">Cinema</span></a><span class="hs-special">]</span><span>
</span><a name="line-66"></a><span>  </span><a name="local-1627468926"><a href="#local-1627468926"><span class="hs-identifier">cinemas</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">handle</span><span> </span><a href="#local-1627468924"><span class="hs-identifier hs-var">cinemaHandle</span></a><span> </span><span class="hs-special">(</span><a href="HTTPRequestModule2.html#httpGetCinemaList"><span class="hs-identifier hs-var">httpGetCinemaList</span></a><span> </span><a href="#local-1627468923"><span class="hs-identifier hs-var">location</span></a><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-1627468927"><a href="#local-1627468927"><span class="hs-identifier">cinema2Handle</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-1627468928"><a href="#local-1627468928"><span class="hs-identifier">e</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="DataBaseModule.html#disconnectDB"><span class="hs-identifier hs-var">disconnectDB</span></a><span> </span><a href="#local-1627468879"><span class="hs-identifier hs-var">conn</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">error</span><span> </span><span class="hs-string">&quot;No cinema found that plays your movie&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">N</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">HttpException</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">[</span><a href="DataStructures.html#Cinema"><span class="hs-identifier hs-type">Cinema</span></a><span class="hs-special">]</span><span>
</span><a name="line-68"></a><span>  </span><a name="local-1627468929"><a href="#local-1627468929"><span class="hs-identifier">filteredCinemas</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">handle</span><span> </span><a href="#local-1627468927"><span class="hs-identifier hs-var">cinema2Handle</span></a><span> </span><span class="hs-special">(</span><a href="HTTPRequestModule2.html#httpApiCinemaRequest"><span class="hs-identifier hs-var">httpApiCinemaRequest</span></a><span>
</span><a name="line-69"></a><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fromJust</span><span> </span><a href="#local-1627468891"><span class="hs-identifier hs-var">movie</span></a><span> </span><span class="hs-operator hs-var">!!</span><span> </span><span class="hs-special">(</span><a href="#local-1627468922"><span class="hs-identifier hs-var">movieIndex</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-1627468926"><span class="hs-identifier hs-var">cinemas</span></a><span class="hs-special">)</span><span>
</span><a name="line-70"></a><span>  </span><a href="IOActionModule.html#printCinemas"><span class="hs-identifier hs-var">printCinemas</span></a><span> </span><a href="#local-1627468929"><span class="hs-identifier hs-var">filteredCinemas</span></a><span>
</span><a name="line-71"></a><span>  </span><a href="DataBaseModule.html#disconnectDB"><span class="hs-identifier hs-var">disconnectDB</span></a><span> </span><a href="#local-1627468879"><span class="hs-identifier hs-var">conn</span></a><span>
</span><a name="line-72"></a><span>
</span><a name="line-73"></a><span class="hs-comment">-- | The main function of this application</span><span>
</span><a name="line-74"></a><span class="hs-identifier">main</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-75"></a><a name="main"><a href="Main.html#main"><span class="hs-identifier">main</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-76"></a><span>  </span><span class="hs-keyword">let</span><span> </span><a name="local-1627468930"><a href="#local-1627468930"><span class="hs-identifier">mainHandler</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">print</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">takeWhile</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">/=</span><span> </span><span class="hs-char">'\n'</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">show</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SomeException</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">IO</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span>  </span><span class="hs-identifier hs-var">handle</span><span> </span><a href="#local-1627468930"><span class="hs-identifier hs-var">mainHandler</span></a><span> </span><a href="Main.html#run"><span class="hs-identifier hs-var">run</span></a><span>
</span><a name="line-78"></a></pre></body></html>